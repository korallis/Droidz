# v2.0.2 Migration Guide

## What Changed

Droidz v2.0.2 corrects the Custom Droid architecture to align with Factory.ai's official specifications.

### The Issue

**v2.0.1 and earlier:**
- Orchestrator tried to delegate directly using Task() calls
- Added "Task" to tools array (invalid)
- Resulted in error: `âŒ Invalid tools: Task`

**Root cause:**
- Misunderstood Factory's Custom Droid architecture
- Custom droids CANNOT invoke other custom droids
- Only main user session can delegate to custom droids

## The Fix (v2.0.2)

### Architecture Change

**Before (Incorrect):**
```
User â†’ Orchestrator (tries to call Task) â†’ Specialists
              â†‘ WRONG: Custom droids can't delegate
```

**After (Correct):**
```
User â†’ Orchestrator (creates plan) â†’ User â†’ Specialists
       (planner)                     (delegator)
```

### Orchestrator Role Changed

**Before:**
- Name: "Coordinates parallel execution"
- Behavior: Attempted to call `Task({subagent_type: "..."})`
- Tools: `["...", "Task"]` â† Invalid!

**After:**
- Name: "Plans parallel execution strategy"
- Behavior: Creates delegation instructions for USER
- Tools: `["...", ]` â† Task removed (not a listable tool)

### Example of Changes

**Old workflow (broken):**
```javascript
// Orchestrator tried to do this:
const result = Task({
  subagent_type: "droidz-codegen",
  prompt: "Implement X"
});
// âŒ Error: Custom droids can't call Task
```

**New workflow (correct):**
```markdown
Orchestrator outputs this:

NEXT STEP: In your main droid session, run:
"Use droidz-codegen to implement PROJ-123 with context: [...]"

Then YOU (user) execute that command
âœ… Works because main session can delegate
```

## How To Update

### Method 1: Pull Latest (Recommended)

```bash
cd /path/to/Droidz
git pull origin main
```

### Method 2: Reinstall

```bash
curl -fsSL https://raw.githubusercontent.com/korallis/Droidz/main/install.sh | bash
```

### Method 3: Manual Fix (If You Modified Droids)

If you customized the droid files, manually apply these changes:

**1. Update orchestrator (.factory/droids/droidz-orchestrator.md):**

```diff
---
name: droidz-orchestrator
-description: Coordinates parallel Linear ticket execution
+description: Plans parallel execution strategy - creates delegation plan for user
model: gpt-5-codex
-tools: ["Read", "LS", "Execute", "Grep", "Glob", "TodoWrite", "WebSearch", "FetchUrl", "Task"]
+tools: ["Read", "LS", "Execute", "Grep", "Glob", "TodoWrite", "WebSearch", "FetchUrl"]
---
```

**2. Update orchestrator behavior:**
- Remove any `Task()` function calls
- Replace with text instructions for USER to execute
- Example: Instead of calling Task, output: "NEXT STEP: Use droidz-codegen to..."

**3. Specialist droids (no changes needed):**
- Already correct if `tools` field is undefined
- If you have explicit tools arrays, remove them (undefined = all tools)

## New Usage Pattern

### Step 1: Ask Orchestrator for Plan

```bash
droid
> "Use droidz-orchestrator to plan implementation of user authentication"
```

### Step 2: Orchestrator Responds with Plan

```markdown
ðŸ“‹ Execution Plan:

Phase 1 (Sequential):
- TASK-1: Database schema â†’ droidz-codegen

Phase 2 (Parallel):
- TASK-2: Auth API â†’ droidz-codegen
- TASK-3: UI components â†’ droidz-codegen
- TASK-4: Tests â†’ droidz-test

NEXT STEPS:
1. "Use droidz-codegen to implement TASK-1: Create user table with Prisma"
2. Then in parallel:
   - "Use droidz-codegen to implement TASK-2: Build JWT auth API"
   - "Use droidz-codegen to implement TASK-3: Create login/signup forms"
   - "Use droidz-test to implement TASK-4: Test auth flow"
```

### Step 3: YOU Execute Delegations

```bash
# Sequential first:
droid
> "Use droidz-codegen to implement TASK-1: Create user table with Prisma"

# Then parallel (multiple terminals):
# Terminal 1:
droid
> "Use droidz-codegen to implement TASK-2: Build JWT auth API"

# Terminal 2:
droid
> "Use droidz-codegen to implement TASK-3: Create login/signup forms"

# Terminal 3:
droid
> "Use droidz-test to implement TASK-4: Test auth flow"
```

## What Didn't Change

### Specialist Droids Still Work the Same

- âœ… Have all tools when `tools` field is undefined
- âœ… Work in isolated git worktrees
- âœ… Create files, run tests, commit, push, create PRs
- âœ… Support ALL models (Claude, GPT, GLM)

### Parallel Execution Still Works

- âœ… Multiple specialists can run simultaneously
- âœ… Each uses isolated git worktree (`.runs/TASK-X/`)
- âœ… 3-5x faster than sequential execution
- âœ… Same time savings calculation

### Model Compatibility Unchanged

All models still supported with full tool access:
- âœ… Claude Sonnet 4.5
- âœ… Claude Opus 4.1
- âœ… Claude Haiku 4.5
- âœ… GPT-5
- âœ… GPT-5 Codex
- âœ… GLM-4.6 (Droid Core)

## Verification

After updating, verify your droids:

```bash
# Enable Custom Droids
droid
/settings  # Toggle "Custom Droids" ON
/quit

# Check droids loaded
droid
/droids  # Should see all 7 droids with no errors

# Test orchestrator
droid
> "Use droidz-orchestrator to plan a simple feature"
# Should output a plan with delegation instructions (not errors)
```

## Common Questions

### Q: Why can't custom droids delegate?

**A:** Factory.ai's architecture:
- Task tool is only available in main droid session
- Custom droids run in isolated contexts
- Only main session has delegation capabilities
- This prevents infinite recursion and context pollution

### Q: Is the orchestrator still useful?

**A:** Yes! More than ever:
- Creates detailed execution plans
- Analyzes dependencies
- Suggests parallel execution strategies
- Breaks down complex work
- Saves YOU from planning manually

### Q: Can I still do parallel execution?

**A:** Absolutely! Just delegate in parallel:
- Open multiple terminal windows
- Run different "Use droidz-X..." commands simultaneously
- Each specialist works in isolated worktree
- Same 3-5x speed improvement

### Q: Do I need to change my workflow?

**A:** Only slightly:
- **Before:** "Use orchestrator" â†’ specialists automatically invoked
- **After:** "Use orchestrator" â†’ YOU invoke specialists
- One extra step, but same end result

## Troubleshooting

### "Invalid tools: Task" Error

âœ… **Fixed in v2.0.2** - Update via:
```bash
git pull origin main
```

### Orchestrator Not Creating Delegations

Check the prompt - orchestrator now outputs text instructions:
```
EXPECTED: "NEXT STEP: Use droidz-codegen to..."
NOT: Task() function calls
```

### Custom Droid Not Found

Enable in settings:
```bash
droid
/settings  # Toggle "Custom Droids" ON
```

## Additional Resources

- **[HOW_TO_USE_DROIDZ.md](./HOW_TO_USE_DROIDZ.md)** - Complete updated workflow
- **[TOOL_COMPATIBILITY.md](./TOOL_COMPATIBILITY.md)** - Architecture details
- **[SOLUTION_SUMMARY.md](./SOLUTION_SUMMARY.md)** - Technical fix summary
- **[CHANGELOG.md](./CHANGELOG.md)** - Full v2.0.2 changes
- **[Factory.ai Docs](https://docs.factory.ai/cli/configuration/custom-droids)** - Official reference

## Support

If you encounter issues after updating:

1. Check [HOW_TO_USE_DROIDZ.md](./HOW_TO_USE_DROIDZ.md) for correct usage
2. Review [TOOL_COMPATIBILITY.md](./TOOL_COMPATIBILITY.md) for architecture
3. Verify Custom Droids are enabled (`/droids` command)
4. Ensure you're using latest version (`git pull origin main`)
5. Open an issue on GitHub with error details

---

**Summary:** Orchestrator is now a planner that creates delegation instructions. YOU (the user) execute those delegations to invoke specialists. Same power, slightly different workflow.
